---
title: 'å¼ºå›½å­¦ä¹ --day3'
date: 2025-11-12
permalink: /posts/2025/11/blog-post-3/
tags:
  - subnet
  - python
  - network
---

# ğŸŒ å­ç½‘åˆ’åˆ†

ä»Šå¤©å¤ä¹ ä¸€ä¸‹å­ç½‘åˆ’åˆ†ï¼Œé¡ºä¾¿å†™äº†ä¸ªå°å·¥å…·
---

## ğŸ§© ä¸€ã€å­ç½‘åˆ’åˆ†çš„æ ¸å¿ƒæ¦‚å¿µ

ä¸€ä¸ª IPv4 åœ°å€ï¼ˆå¦‚ `192.168.10.25`ï¼‰æ˜¯ 32 ä½äºŒè¿›åˆ¶ï¼š
```js
11000000.10101000.00001010.00011001
```

å®ƒè¢«åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š
```js
[ ç½‘ç»œä½ | ä¸»æœºä½ ]
```
**æ©ç  (Subnet Mask)** å‘Šè¯‰æˆ‘ä»¬ç½‘ç»œä½å å¤šå°‘ã€‚  
ä¾‹å¦‚ï¼š  
`255.255.255.0` â†’ `/24`ï¼Œå³å‰ 24 ä½æ˜¯ç½‘ç»œä½ã€‚  

---


## ğŸ§® äºŒã€è®¡ç®—åŸç†æ­¥éª¤

å‡è®¾ä¸»ç½‘æ®µæ˜¯ï¼š
```js
192.168.0.0/24 â†’ æœ‰ 256 ä¸ªåœ°å€ï¼ˆ0â€“255ï¼‰
```

æœ‰ä¸‰ä¸ªå­ç½‘éœ€æ±‚ï¼š
| åç§° | ä¸»æœºéœ€æ±‚ |
|------|-----------|
| HQ | 100 |
| BranchA | 50 |
| BranchB | 20 |

### Step 1ï¸âƒ£ï¼šæ’åºï¼ˆä»å¤§åˆ°å°ï¼‰
å…ˆæ’åºï¼Œç¡®ä¿å¤§å­ç½‘å…ˆåˆ†é…ï¼Œé¿å…ç¢ç‰‡æµªè´¹ï¼š
```js
HQ (100)ï¼ŒBranchA (50)ï¼ŒBranchB (20)
```

---

### Step 2ï¸âƒ£ï¼šè®¡ç®—æ¯ä¸ªå­ç½‘çš„æœ€å°æ©ç 

> å­ç½‘èƒ½å®¹çº³ä¸»æœºæ•° = 2^(ä¸»æœºä½æ•°) - 2  
> ï¼ˆå‡ 2 æ˜¯å› ä¸ºè¦å»æ‰ç½‘ç»œåœ°å€å’Œå¹¿æ’­åœ°å€ä¸èƒ½åˆ†é…ï¼‰

æˆ‘ä»¬è¦æ±‚å‡º **æ»¡è¶³â€œä¸»æœºæ•° â‰¥ éœ€æ±‚æ•°â€çš„æœ€å°ä¸»æœºä½æ•°**ã€‚

#### ï¼ˆ1ï¼‰HQ éœ€è¦ 100 å°ä¸»æœº  
æ‰¾æœ€å°æ»¡è¶³æ¡ä»¶çš„ä¸»æœºä½æ•°ï¼š

| ä¸»æœºä½æ•° | å¯ç”¨ä¸»æœºæ•° | æ˜¯å¦å¤Ÿç”¨ |
|-----------|-------------|-----------|
| 5 | 30 | âŒ |
| 6 | 62 | âŒ |
| 7 | 126 | âœ… |

â†’ 7 ä½ä¸»æœºä½  
â†’ å­ç½‘æ©ç  = 32 - 7 = **/25**  
â†’ å³ `255.255.255.128`

æ­¤æ—¶ï¼š
```js
ç½‘ç»œåœ°å€ï¼š192.168.0.0
å¹¿æ’­åœ°å€ï¼š192.168.0.127
å¯ç”¨IPï¼š192.168.0.1 â€“ 192.168.0.126
```

---

#### ï¼ˆ2ï¼‰BranchA éœ€è¦ 50 å°ä¸»æœº
| ä¸»æœºä½æ•° | å¯ç”¨ä¸»æœºæ•° | ç»“æœ |
|-----------|-------------|------|
| 5 | 30 | âŒ |
| 6 | 62 | âœ… |

â†’ /26 æ©ç ï¼ˆ255.255.255.192ï¼‰

ä¸Šä¸€ä¸ªå­ç½‘åˆ° `.127` ç»“æŸï¼Œ  
ä¸‹ä¸€ä¸ªå­ç½‘ä» `.128` å¼€å§‹ï¼š
```js
ç½‘ç»œåœ°å€ï¼š192.168.0.128
å¹¿æ’­åœ°å€ï¼š192.168.0.191
å¯ç”¨IPï¼š192.168.0.129 â€“ 192.168.0.190
```

---

#### ï¼ˆ3ï¼‰BranchB éœ€è¦ 20 å°ä¸»æœº
| ä¸»æœºä½æ•° | å¯ç”¨ä¸»æœºæ•° | ç»“æœ |
|-----------|-------------|------|
| 4 | 14 | âŒ |
| 5 | 30 | âœ… |

â†’ /27 æ©ç ï¼ˆ255.255.255.224ï¼‰

èµ·ç‚¹æ˜¯ `.192`ï¼š
```js
ç½‘ç»œåœ°å€ï¼š192.168.0.192
å¹¿æ’­åœ°å€ï¼š192.168.0.223
å¯ç”¨IPï¼š192.168.0.193 â€“ 192.168.0.222
```

---

### Step 3ï¸âƒ£ï¼šè®°å½•â€œå·²åˆ†é…çš„å­ç½‘â€å’Œâ€œå‰©ä½™åœ°å€ç©ºé—´â€

åˆ†é…å®Œç¬¬ä¸‰ä¸ª `/27` å­ç½‘ï¼š  
å¹¿æ’­åˆ° `.223`  
æ‰€ä»¥å‰©ä½™ï¼š
```js
192.168.0.224 â€“ 192.168.0.255 â†’ å…± 32 ä¸ªåœ°å€
```

---

## âš™ï¸ å››ã€ç¨‹åºä¸­åŸç†çš„å®ç°

æ ¸å¿ƒè®¡ç®—é€»è¾‘å°±æ˜¯è¿™å‡ æ­¥ï¼š

```python  
required = hosts_needed + 2          # åŠ ä¸Šç½‘ç»œå’Œå¹¿æ’­åœ°å€  
prefix_len = 32  
while 2 ** (32 - prefix_len) < required:  
    prefix_len -= 1                  # æ‰¾åˆ°æœ€å°æ»¡è¶³åœ°å€æ•°é‡çš„å‰ç¼€  
```
ç„¶åç¡®å®šå­ç½‘ï¼š
```python
subnet = ipaddress.ip_network(f"{next_net}/{prefix_len}", strict=False)
```
æ¥ç€æ›´æ–°å¯ç”¨èµ·ç‚¹ï¼š
```python
next_net = subnet.broadcast_address + 1
```

## ä»£ç 
```python
import tkinter as tk
from tkinter import ttk, messagebox, filedialog
import ipaddress
import csv
import os
from prettytable import PrettyTable


def calculate_vlsm(network, subnet_requirements):
    """æ ¹æ®ä¸»æœºéœ€æ±‚åˆ†é…å­ç½‘ï¼ˆVLSM åˆ†é…ï¼‰"""
    subnet_requirements.sort(key=lambda x: x[1], reverse=True)
    allocated_subnets = []
    next_net = network.network_address

    for name, hosts_needed in subnet_requirements:
        required = hosts_needed + 2
        prefix_len = 32
        while 2 ** (32 - prefix_len) < required:
            prefix_len -= 1

        try:
            subnet = ipaddress.ip_network(f"{next_net}/{prefix_len}", strict=False)
        except ValueError:
            messagebox.showerror("é”™è¯¯", f"æ— æ³•ä¸º {name} åˆ†é…å­ç½‘ï¼Œåœ°å€ç©ºé—´ä¸è¶³ã€‚")
            break

        if subnet.network_address not in network:
            messagebox.showerror("é”™è¯¯", f"å­ç½‘ {name} è¶…å‡ºä¸»ç½‘èŒƒå›´ã€‚")
            break

        allocated_subnets.append((name, hosts_needed, subnet))
        next_net = subnet.broadcast_address + 1

        if next_net not in network:
            break

    remaining = None
    if next_net <= network.broadcast_address:
        remaining = ipaddress.ip_network(f"{next_net}/{network.prefixlen}", strict=False)

    return allocated_subnets, remaining


class VLSMApp:
    def __init__(self, root):
        self.root = root
        self.root.title("å¯å˜é•¿å­ç½‘åˆ’åˆ†å·¥å…· (VLSM)")
        self.root.geometry("950x650")
        self.root.resizable(False, False)

        frame_input = tk.LabelFrame(root, text="åŸºç¡€ä¿¡æ¯", padx=10, pady=10)
        frame_input.pack(fill="x", padx=10, pady=5)

        tk.Label(frame_input, text="ä¸»ç½‘æ®µ:").grid(row=0, column=0, sticky="w")
        self.entry_network = tk.Entry(frame_input, width=20)
        self.entry_network.grid(row=0, column=1, padx=5)
        self.entry_network.insert(0, "192.168.0.0/24")

        tk.Label(frame_input, text="å­ç½‘æ•°é‡:").grid(row=0, column=2, sticky="w")
        self.entry_count = tk.Entry(frame_input, width=5)
        self.entry_count.grid(row=0, column=3, padx=5)
        self.entry_count.insert(0, "3")

        tk.Button(frame_input, text="æ·»åŠ å­ç½‘è¾“å…¥è¡¨", command=self.create_subnet_entries).grid(row=0, column=4, padx=10)
        tk.Button(frame_input, text="æ¸…ç©ºè¾“å…¥", bg="#ff6666", fg="white", command=self.reset_all).grid(row=0, column=5, padx=10)

        self.frame_subnets = tk.LabelFrame(root, text="å­ç½‘éœ€æ±‚è¾“å…¥", padx=10, pady=10)
        self.frame_subnets.pack(fill="x", padx=10, pady=5)
        self.subnet_entries = []

        frame_btns = tk.Frame(root)
        frame_btns.pack(fill="x", pady=5)
        tk.Button(frame_btns, text="å¼€å§‹è®¡ç®—", bg="#4CAF50", fg="white", font=("Arial", 12, "bold"), command=self.calculate).pack(side="left", padx=5)
        tk.Button(frame_btns, text="å¯¼å‡ºç»“æœ (CSV)", bg="#2196F3", fg="white", font=("Arial", 12, "bold"), command=self.export_csv).pack(side="left", padx=5)

        frame_result = tk.LabelFrame(root, text="åˆ†é…ç»“æœ", padx=10, pady=10)
        frame_result.pack(fill="both", expand=True, padx=10, pady=5)

        columns = ("name", "hosts_needed", "usable", "network", "mask", "broadcast", "ip_range")
        self.tree = ttk.Treeview(frame_result, columns=columns, show="headings", height=15)
        for col, name in zip(columns, ["å­ç½‘åç§°", "éœ€æ±‚ä¸»æœºæ•°", "å¯ç”¨ä¸»æœºæ•°", "ç½‘ç»œåœ°å€", "å­ç½‘æ©ç ", "å¹¿æ’­åœ°å€", "å¯ç”¨ IP èŒƒå›´"]):
            self.tree.heading(col, text=name)
            self.tree.column(col, anchor="center", width=130)
        self.tree.pack(fill="both", expand=True)

        self.remaining_label = tk.Label(root, text="", fg="#555", font=("Arial", 10, "italic"))
        self.remaining_label.pack(pady=3)

    def create_subnet_entries(self):
        for widget in self.frame_subnets.winfo_children():
            widget.destroy()

        try:
            count = int(self.entry_count.get())
        except ValueError:
            messagebox.showerror("é”™è¯¯", "è¯·è¾“å…¥æœ‰æ•ˆçš„å­ç½‘æ•°é‡ã€‚")
            return

        self.subnet_entries = []
        for i in range(count):
            tk.Label(self.frame_subnets, text=f"å­ç½‘{i+1} åç§°:").grid(row=i, column=0, sticky="w")
            name_entry = tk.Entry(self.frame_subnets, width=15)
            name_entry.grid(row=i, column=1, padx=5)
            name_entry.insert(0, f"Subnet_{i+1}")

            tk.Label(self.frame_subnets, text="ä¸»æœºæ•°é‡:").grid(row=i, column=2, sticky="w")
            hosts_entry = tk.Entry(self.frame_subnets, width=10)
            hosts_entry.grid(row=i, column=3, padx=5)
            hosts_entry.insert(0, "50")

            self.subnet_entries.append((name_entry, hosts_entry))

    def reset_all(self):
        self.entry_network.delete(0, tk.END)
        self.entry_network.insert(0, "192.168.0.0/24")

        self.entry_count.delete(0, tk.END)
        self.entry_count.insert(0, "3")

        for widget in self.frame_subnets.winfo_children():
            widget.destroy()

        for item in self.tree.get_children():
            self.tree.delete(item)

        self.remaining_label.config(text="")
        self.subnet_entries = []

    def calculate(self):
        for item in self.tree.get_children():
            self.tree.delete(item)
        self.remaining_label.config(text="")

        try:
            network = ipaddress.ip_network(self.entry_network.get(), strict=False)
        except ValueError:
            messagebox.showerror("é”™è¯¯", "ä¸»ç½‘æ®µæ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æ­£ç¡®çš„CIDRæ ¼å¼ï¼ˆä¾‹ï¼š192.168.0.0/24ï¼‰")
            return

        requirements = []
        for name_entry, host_entry in self.subnet_entries:
            try:
                name = name_entry.get().strip()
                hosts = int(host_entry.get())
                if not name:
                    raise ValueError
                requirements.append((name, hosts))
            except ValueError:
                messagebox.showerror("é”™è¯¯", "è¯·è¾“å…¥æœ‰æ•ˆçš„å­ç½‘åç§°å’Œä¸»æœºæ•°ã€‚")
                return

        allocated, remaining = calculate_vlsm(network, requirements)

        for name, needed, subnet in allocated:
            hosts = list(subnet.hosts())
            usable = len(hosts)
            ip_range = f"{hosts[0]} - {hosts[-1]}" if usable > 0 else "æ— å¯ç”¨IP"
            self.tree.insert("", "end", values=(
                name, needed, usable,
                str(subnet.network_address),
                f"{subnet.netmask} (/{subnet.prefixlen})",
                str(subnet.broadcast_address),
                ip_range
            ))

        if remaining:
            self.remaining_label.config(
                text=f"å‰©ä½™æœªåˆ†é…åœ°å€ç©ºé—´ï¼š{remaining.network_address} - {remaining.broadcast_address} ({remaining.num_addresses} ä¸ªåœ°å€)"
            )
        else:
            self.remaining_label.config(text="æ‰€æœ‰åœ°å€ç©ºé—´å·²åˆ†é…å®Œæ¯•ã€‚")

    def export_csv(self):
        if not self.tree.get_children():
            messagebox.showwarning("æç¤º", "æ²¡æœ‰ç»“æœå¯å¯¼å‡ºï¼Œè¯·å…ˆè®¡ç®—ã€‚")
            return

        file_path = filedialog.asksaveasfilename(
            defaultextension=".csv",
            filetypes=[("CSV æ–‡ä»¶", "*.csv"), ("æ‰€æœ‰æ–‡ä»¶", "*.*")]
        )
        if not file_path:
            return

        with open(file_path, "w", newline="", encoding="utf-8-sig") as f:
            writer = csv.writer(f)
            headers = ["å­ç½‘åç§°", "éœ€æ±‚ä¸»æœºæ•°", "å¯ç”¨ä¸»æœºæ•°", "ç½‘ç»œåœ°å€", "å­ç½‘æ©ç ", "å¹¿æ’­åœ°å€", "å¯ç”¨ IP èŒƒå›´"]
            writer.writerow(headers)
            for item in self.tree.get_children():
                writer.writerow(self.tree.item(item)["values"])

        messagebox.showinfo("æˆåŠŸ", f"ç»“æœå·²å¯¼å‡ºåˆ°ï¼š{os.path.abspath(file_path)}")


if __name__ == "__main__":
    root = tk.Tk()
    app = VLSMApp(root)
    root.mainloop()
```